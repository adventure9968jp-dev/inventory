<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßß Âπ∏ÈÅãËΩâÁõ§ - ÂñúÊ∞£Ê¥ãÊ¥ãÁâà</title>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- SheetJS (XLSX) for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background: radial-gradient(circle at center, #fff1f2 0%, #ffe4e6 100%);
            height: 100vh;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        @media (max-width: 1024px) {
            body {
                height: auto;
                min-height: 100vh;
                overflow-y: auto;
                padding-bottom: 2rem;
            }
        }

        .impact-panel {
            background: rgba(255, 255, 255, 0.95);
            border: 4px solid #F87171; /* Red-400 */
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.5), 0 20px 40px -5px rgba(220, 38, 38, 0.3);
            border-radius: 24px;
        }

        .list-card-shadow {
            box-shadow: 4px 4px 0px 0px #DC2626; /* Red-600 */
            border: 2px solid #EF4444; /* Red-500 */
            transition: all 0.1s;
        }
        
        .list-card-shadow:active {
            transform: translate(2px, 2px);
            box-shadow: 0px 0px 0px 0px #DC2626;
        }

        .selected-prize-card {
            border: 3px solid #E11D48 !important; /* Rose-600 */
            box-shadow: 0 0 0 2px #ffe4e6, 4px 4px 0px 0px #E11D48 !important;
            background-color: #fff1f2 !important; /* Rose-50 */
            transform: scale(1.02);
        }

        .gold-text-impact {
            background: linear-gradient(180deg, #F59E0B 0%, #D97706 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 0px rgba(251, 191, 36, 0.2);
            font-weight: 900;
        }

        .animate-pop {
            animation: highlight 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .animate-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes highlight {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        @keyframes rainbow-flash {
            0% { border-color: #ff0000; box-shadow: 0 0 30px #ff0000; }
            15% { border-color: #ff7f00; box-shadow: 0 0 30px #ff7f00; }
            30% { border-color: #ffff00; box-shadow: 0 0 30px #ffff00; }
            45% { border-color: #00ff00; box-shadow: 0 0 30px #00ff00; }
            60% { border-color: #0000ff; box-shadow: 0 0 30px #0000ff; }
            75% { border-color: #4b0082; box-shadow: 0 0 30px #4b0082; }
            90% { border-color: #9400d3; box-shadow: 0 0 30px #9400d3; }
            100% { border-color: #ff0000; box-shadow: 0 0 30px #ff0000; }
        }

        .rainbow-border {
            animation: rainbow-flash 1.5s linear infinite;
            border-width: 8px;
            border-style: solid;
        }

        .dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .drag-over {
            border-color: #ef4444 !important; /* Red-500 */
            background-color: #fef2f2 !important; /* Red-50 */
            border-style: dashed !important;
        }

        /* Ê¥ªË∫çÊ†ºÂ≠êÊ®£Âºè */
        .grid-cell-active {
            background: #FEF08A; /* Yellow-200 */
            border-color: #EAB308; /* Yellow-500 */
            transform: scale(1.0);
            box-shadow: 0 0 20px rgba(234, 179, 8, 0.8);
            z-index: 10;
        }
        
        /* ‰∏≠ÁçéÊ†ºÂ≠êÊ®£Âºè */
        .grid-cell-winner {
            background: linear-gradient(135deg, #FCD34D 0%, #F59E0B 100%);
            border-color: #B45309;
            color: white;
            /* transform: scale(1.1); Â∑≤ÁßªÈô§Á∏ÆÊîæ */
            box-shadow: 0 0 40px rgba(245, 158, 11, 0.9);
            z-index: 20;
            animation: highlight 0.5s infinite;
        }

        /* ‰∏ÄËà¨Ê†ºÂ≠êÊ®£Âºè */
        .grid-cell-normal {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); /* Red-500 to Red-600 */
            border-color: #fca5a5; /* Red-300 */
            color: white;
        }
        
        /* Â∑≤‰∏≠ÁçéËÄÖÊ®£Âºè (ÈªëÂ∫ïÁôΩÂ≠ó) */
        .grid-cell-already-won {
            background: #1f2937; /* Gray-800 */
            border-color: #000000;
            color: white;
            opacity: 0.8;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px; /* Â¢ûÂä†Ê∞¥Âπ≥Êç≤Ëª∏È´òÂ∫¶Ë®≠ÂÆö */
        }
        ::-webkit-scrollbar-track {
            background: #ffe4e6;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb {
            background: #f43f5e; 
            border-radius: 5px;
            border: 2px solid #ffe4e6;
        }
        /* Èö±ËóèÊç≤Ëª∏ËßíËêΩÁöÑÁÅ∞Ëâ≤ÊñπÂ°ä */
        ::-webkit-scrollbar-corner {
            background: transparent;
        }
        
        .cursor-grab {
            cursor: grab;
        }
        .cursor-grab:active {
            cursor: grabbing;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- Sound Manager (Fixed & Consolidated) ---
        const SoundManager = {
            ctx: null,
            customSpinUrl: null,
            customWinUrl: null,
            spinAudio: null, 
            winAudio: null,

            init: function() {
                if (!this.ctx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            },
            
            setCustomSpin: function(url) {
                this.customSpinUrl = url;
                if (url) {
                    this.spinAudio = new Audio(url);
                    this.spinAudio.loop = true; 
                    this.spinAudio.volume = 0.6; 
                } else {
                    this.spinAudio = null;
                }
            },

            setCustomWin: function(url) {
                this.customWinUrl = url;
                if (url) {
                    this.winAudio = new Audio(url);
                    this.winAudio.volume = 1.0;
                } else {
                    this.winAudio = null;
                }
            },

            playTone: function(freq, type, duration, startTime = 0, volume = 0.1) {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime + startTime);
                gain.gain.setValueAtTime(volume, this.ctx.currentTime + startTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + startTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(this.ctx.currentTime + startTime);
                osc.stop(this.ctx.currentTime + startTime + duration);
            },

            // Start continuous spin sound (loop)
            startSpin: function() {
                this.init();
                if (this.spinAudio) {
                    this.spinAudio.currentTime = 0;
                    this.spinAudio.play().catch(() => {});
                }
            },

            // Stop continuous spin sound
            stopSpin: function() {
                if (this.spinAudio) {
                    this.spinAudio.pause();
                    this.spinAudio.currentTime = 0;
                }
            },

            // Play a single tick sound (for grid movement)
            tick: function() {
                if (this.spinAudio) return; // Don't tick if custom loop is playing
                this.init();
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'triangle';
                const freq = 800 + Math.random() * 100;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.08);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.08);
            },

            // Backward compatibility alias
            spin: function() {
                this.tick();
            },

            win: function() {
                this.init();
                if (this.winAudio) {
                    this.winAudio.currentTime = 0;
                    this.winAudio.play().catch(() => {});
                } else {
                    if (!this.ctx) return;
                    this.playTone(523.25, 'sine', 0.4, 0, 0.15);      
                    this.playTone(659.25, 'sine', 0.4, 0.1, 0.15);    
                    this.playTone(783.99, 'sine', 0.4, 0.2, 0.15);    
                    this.playTone(1046.50, 'triangle', 0.8, 0.3, 0.2); 
                }
            },

            confirm: function() {
                this.init();
                if (!this.ctx) return;
                this.playTone(880, 'sine', 0.6, 0, 0.1); 
            }
        };

        // --- Icon Components ---
        const Icon = ({ children, className, size = 24, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Clover = (props) => (<Icon {...props}><path d="M16.2 7.8 16.7 5.3a2 2 0 0 0-3.5-1.5L12 6.1 10.8 3.8a2 2 0 0 0-3.5 1.5l.5 2.5-2.5-.5a2 2 0 0 0-1.5 3.5l2.3 1.2-2.3 1.2a2 2 0 0 0 1.5 3.5l2.5-.5-.5 2.5a2 2 0 0 0 3.5 1.5l1.2-2.3 1.2 2.3a2 2 0 0 0 3.5-1.5l-.5-2.5 2.5.5a2 2 0 0 0 1.5-3.5l-2.3-1.2 2.3-1.2a2 2 0 0 0-1.5-3.5z" /><path d="M12 18v4" /></Icon>);
        const Plus = (props) => (<Icon {...props}><path d="M5 12h14" /><path d="M12 5v14" /></Icon>);
        const X = (props) => (<Icon {...props}><path d="M18 6 6 18" /><path d="m6 6 12 12" /></Icon>);
        const Settings = (props) => (<Icon {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></Icon>);
        const Gift = (props) => (<Icon {...props}><rect x="3" y="8" width="18" height="4" rx="1" /><path d="M12 8v13" /><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7" /><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5" /></Icon>);
        const Trophy = (props) => (<Icon {...props}><circle cx="12" cy="8" r="6" /><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11" /></Icon>);
        const Users = (props) => (<Icon {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></Icon>);
        const RefreshCw = (props) => (<Icon {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M8 16H3v5" /></Icon>);
        const CheckCircle = (props) => (<Icon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><path d="m9 11 3 3L22 4" /></Icon>);
        const Trash2 = (props) => (<Icon {...props}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></Icon>);
        const Building = (props) => (<Icon {...props}><rect width="16" height="20" x="4" y="2" rx="2" ry="2" /><path d="M9 22v-4h6v4" /><path d="M8 6h.01" /><path d="M16 6h.01" /><path d="M8 10h.01" /><path d="M16 10h.01" /><path d="M8 14h.01" /><path d="M16 14h.01" /></Icon>);
        const Upload = (props) => (<Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></Icon>);
        const Download = (props) => (<Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></Icon>);
        const Shield = (props) => (<Icon {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /></Icon>);
        const AlertTriangle = (props) => (<Icon {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></Icon>);
        const Undo2 = (props) => (<Icon {...props}><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></Icon>);
        const Redo2 = (props) => (<Icon {...props}><path d="m15 14 5-5-5-5"/><path d="M20 9H9.5A5.5 5.5 0 0 0 4 14.5v0A5.5 5.5 0 0 0 9.5 20H13"/></Icon>);
        const FileSpreadsheet = (props) => (<Icon {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></Icon>);
        const Coins = (props) => (<Icon {...props}><circle cx="8" cy="8" r="6" /><path d="M18.09 10.37A6 6 0 1 1 10.34 18" /><path d="M7 6h1v4" /><path d="m7.1 13.84.3-1.8" /></Icon>);
        const Pencil = (props) => (<Icon {...props}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></Icon>);
        const GripVertical = (props) => (<Icon {...props}><circle cx="9" cy="12" r="1" /><circle cx="9" cy="5" r="1" /><circle cx="9" cy="19" r="1" /><circle cx="15" cy="12" r="1" /><circle cx="15" cy="5" r="1" /><circle cx="15" cy="19" r="1" /></Icon>);
        const Volume2 = (props) => (<Icon {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><path d="M15.54 8.46a5 5 0 0 1 0 7.07" /><path d="M19.07 4.93a10 10 0 0 1 0 14.14" /></Icon>);
        const Play = (props) => (<Icon {...props}><polygon points="5 3 19 12 5 21 5 3" /></Icon>);
        const UserList = (props) => (<Icon {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /><path d="M8 14h.01" /><path d="M12 14h.01" /><path d="M16 14h.01" /><path d="M8 18h.01" /><path d="M12 18h.01" /><path d="M16 18h.01" /></Icon>);

        // È†êË®≠Ë≥áÊñô
        const DEFAULT_SCENES = [
            {
                id: 'scene-1',
                title: 'ÈÉ®ÈñÄËÅöÈ§ê',
                participants: [
                    { id: 1, name: 'Â∞èÊòé', group: 'Ê•≠ÂãôÈÉ®', active: true, won: false, bonusWon: false },
                    { id: 2, name: 'Â∞èËèØ', group: 'Ê•≠ÂãôÈÉ®', active: true, won: false, bonusWon: false },
                    { id: 3, name: 'ÁæéÁæé', group: 'Ë°åÈä∑ÈÉ®', active: true, won: false, bonusWon: false },
                    { id: 4, name: 'Â§ßÂ£Ø', group: 'Â∑•Á®ãÈÉ®', active: true, won: false, bonusWon: false },
                    { id: 5, name: 'ÈòøÂº∑', group: 'Â∑•Á®ãÈÉ®', active: true, won: false, bonusWon: false },
                    { id: 6, name: 'ËÄÅÈóÜ', group: 'ÁÆ°ÁêÜÂ±§', active: false, won: false, bonusWon: false },
                ],
                prizes: [
                    { id: 1, name: 'ÁèæÈáë $1000', count: 3, value: 1000, isBonus: false },
                    { id: 2, name: 'Áâπ‰ºë‰∏ÄÊó•Âà∏', count: 1, value: 0, isBonus: false },
                ],
                history: [],
                weights: {}
            },
            {
                id: 'scene-2',
                title: 'Âπ¥ÁµÇÂ∞æÁâô',
                participants: [
                    { id: 1, name: 'Â∑•Á®ãÂ∏´A', group: 'Á†îÁôºËôï', active: true, won: false, bonusWon: false },
                    { id: 2, name: 'Ë®≠Ë®àÂ∏´B', group: 'Ë®≠Ë®àËôï', active: true, won: false, bonusWon: false },
                    { id: 3, name: 'PM C', group: 'Áî¢ÂìÅËôï', active: true, won: false, bonusWon: false },
                ],
                prizes: [
                    { id: 1, name: 'iPhone 15', count: 1, value: 29900, isBonus: false },
                ],
                history: [],
                weights: {}
            }
        ];

        const App = () => {
            const [history, setHistory] = useState({
                past: [],
                present: DEFAULT_SCENES,
                future: []
            });
            
            const scenes = history.present;

            const setScenes = (newScenesOrFn) => {
                setHistory(curr => {
                    const newPresent = typeof newScenesOrFn === 'function' 
                        ? newScenesOrFn(curr.present) 
                        : newScenesOrFn;
                    
                    if (newPresent === curr.present) return curr;

                    return {
                        past: [...curr.past, curr.present],
                        present: newPresent,
                        future: []
                    };
                });
            };

            const undo = () => {
                setHistory(curr => {
                    if (curr.past.length === 0) return curr;
                    const previous = curr.past[curr.past.length - 1];
                    const newPast = curr.past.slice(0, curr.past.length - 1);
                    return {
                        past: newPast,
                        present: previous,
                        future: [curr.present, ...curr.future]
                    };
                });
            };

            const redo = () => {
                setHistory(curr => {
                    if (curr.future.length === 0) return curr;
                    const next = curr.future[0];
                    const newFuture = curr.future.slice(1);
                    return {
                        past: [...curr.past, curr.present],
                        present: next,
                        future: newFuture
                    };
                });
            };

            const [activeSceneId, setActiveSceneId] = useState('scene-1');
            const [isSpinning, setIsSpinning] = useState(false);
            
            // Áî®Êñº Grid È°ØÁ§∫ÁöÑËÆäÊï∏
            const [drawPool, setDrawPool] = useState([]); // ÂèÉËàáÁï∂Ê¨°ÊäΩÁçéÁöÑÊ±†Â≠ê (ÂÉÖË¶ñË¶∫Âø´ÁÖß)
            const [highlightId, setHighlightId] = useState(null); // ÁõÆÂâçË∑≥Âà∞Ë™∞

            const [showSettings, setShowSettings] = useState(false);
            const [showWinnerModal, setShowWinnerModal] = useState(false);
            const [lastWinner, setLastWinner] = useState(null);
            const [selectedPrizeId, setSelectedPrizeId] = useState(null);

            // Removed showRedrawMenu
            const [showRedrawModal, setShowRedrawModal] = useState(false);
            const [isRedrawSpinning, setIsRedrawSpinning] = useState(false);
            
            // For Redraw Modal result display (just name string or object)
            const [redrawDisplay, setRedrawDisplay] = useState(null);
            
            // Removed redrawSelectedGroups

            const [currentRedrawTarget, setCurrentRedrawTarget] = useState(null);
            
            const [newNameList, setNewNameList] = useState('');
            const [newGroupName, setNewGroupName] = useState('‰∏ÄËà¨'); 
            const [newPrizeName, setNewPrizeName] = useState('');
            const [newPrizeCount, setNewPrizeCount] = useState(1);
            const [newPrizeValue, setNewPrizeValue] = useState(0); 
            // Removed newPrizeIsBonus state
            
            const [dragOverGroup, setDragOverGroup] = useState(null);
            const [visibleGroups, setVisibleGroups] = useState(new Set()); 

            const [showAdminLogin, setShowAdminLogin] = useState(false);
            const [showAdminPanel, setShowAdminPanel] = useState(false);
            const [adminPasswordInput, setAdminPasswordInput] = useState('');
            const [loginError, setLoginError] = useState(false);
            const [adminTargetPrizeId, setAdminTargetPrizeId] = useState(null);
            const [editingPrize, setEditingPrize] = useState(null);
            
            const [showBonusModal, setShowBonusModal] = useState(false);
            const [bonusName, setBonusName] = useState('Âä†Á¢ºÁ¥ÖÂåÖ');
            const [bonusAmount, setBonusAmount] = useState(1000);
            const [bonusCount, setBonusCount] = useState(1);

            // Prize Winner List Modal State
            const [viewingPrizeWinners, setViewingPrizeWinners] = useState(null);

            // Custom Sound States
            const [customSoundNames, setCustomSoundNames] = useState({ spin: '', win: '' });
            const spinSoundInputRef = useRef(null);
            const winSoundInputRef = useRef(null);

            const timerRef = useRef(null);
            const fileInputRef = useRef(null); 
            const participantsInputRef = useRef(null); 
            
            // NEW REFS
            const mainGridRef = useRef(null);
            const redrawGridRef = useRef(null);

            const currentScene = scenes.find(s => s.id === activeSceneId) || scenes[0];

            useEffect(() => {
                setSelectedPrizeId(null);
                const groups = new Set();
                currentScene.participants.forEach(p => groups.add(p.group || 'Êú™ÂàÜÈ°û'));
                setVisibleGroups(groups);
            }, [activeSceneId, currentScene.participants.length]); 

            // Scroll effect for Grid Animation (Enhanced & Fixed for Jumping)
            useEffect(() => {
                if (highlightId) {
                    // Helper to scroll specific container without moving window
                    const scrollToCenter = (container, elementId) => {
                        if (!container) return false;
                        const element = document.getElementById(elementId);
                        if (!element) return false;
                        
                        const containerRect = container.getBoundingClientRect();
                        const elementRect = element.getBoundingClientRect();
                        
                        // Calculate offset from container top
                        const relativeTop = elementRect.top - containerRect.top;
                        
                        // Target scrollTop = Current scrollTop + relativeTop - (containerHeight/2) + (elementHeight/2)
                        const targetScroll = container.scrollTop + relativeTop - (container.clientHeight / 2) + (element.clientHeight / 2);
                        
                        container.scrollTop = targetScroll;
                        return true;
                    };

                    // 1. Try Redraw Modal
                    if (showRedrawModal && redrawGridRef.current) {
                        const found = scrollToCenter(redrawGridRef.current, `redraw-cell-${highlightId}`);
                        if (found) return;
                    }

                    // 2. Main Grid
                    if (mainGridRef.current) {
                        scrollToCenter(mainGridRef.current, `cell-${highlightId}`);
                    }
                }
            }, [highlightId, showRedrawModal]);

            const currentPrize = useMemo(() => {
                if (selectedPrizeId) {
                    const p = currentScene.prizes.find(p => p.id === selectedPrizeId);
                    if (p) return p;
                }
                return currentScene.prizes.find(p => p.count > 0) || currentScene.prizes[0];
            }, [currentScene.prizes, selectedPrizeId]);

            const groupedParticipants = useMemo(() => {
                const groups = {};
                currentScene.participants.forEach(p => {
                    const gName = p.group || 'Êú™ÂàÜÈ°û';
                    if (!groups[gName]) groups[gName] = [];
                    groups[gName].push(p);
                });
                return groups;
            }, [currentScene.participants]);

            // Ë®àÁÆóÁõÆÂâçÁçéÈ†ÖÁöÑ„ÄåÊúâÊïàÈ°ØÁ§∫Ê±†„Äç(Áî®ÊñºÈ°ØÁ§∫ Grid)
            // ‰øÆÊîπÔºöÁèæÂú®‰∏çÈö±Ëóè‰∏≠ÁçéËÄÖÔºåÈ°ØÁ§∫ÊâÄÊúâÁ¨¶ÂêàÁæ§ÁµÑ‰∏îActiveÁöÑ‰∫∫
            const gridCandidates = useMemo(() => {
                if (isSpinning || showWinnerModal || showRedrawModal) return drawPool;
                
                return currentScene.participants.filter(p => 
                    p.active && 
                    visibleGroups.has(p.group || 'Êú™ÂàÜÈ°û')
                );
            }, [currentScene, visibleGroups, isSpinning, showWinnerModal, showRedrawModal, drawPool]);

            const totalWonValue = useMemo(() => {
                return currentScene.history.reduce((acc, curr) => acc + (curr.prizeValue || 0), 0);
            }, [currentScene.history]);

            const totalAmount = useMemo(() => {
                const remaining = currentScene.prizes.reduce((acc, curr) => acc + (curr.count * (curr.value || 0)), 0);
                return remaining + totalWonValue;
            }, [currentScene.prizes, totalWonValue]);

            const toggleGroupVisibility = (groupName) => {
                const newVisible = new Set(visibleGroups);
                if (newVisible.has(groupName)) newVisible.delete(groupName);
                else newVisible.add(groupName);
                setVisibleGroups(newVisible);
            };

            const toggleAllGroups = () => {
                const allGroups = Object.keys(groupedParticipants);
                if (visibleGroups.size === allGroups.length) {
                    setVisibleGroups(new Set());
                } else {
                    setVisibleGroups(new Set(allGroups));
                }
            };

            const handleExport = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(scenes));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "lucky_draw_backup.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const handleImport = (event) => {
                const fileObj = event.target.files && event.target.files[0];
                if (!fileObj) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedScenes = JSON.parse(e.target.result);
                        if (Array.isArray(importedScenes)) {
                            const safeScenes = importedScenes.map(s => ({ ...s, weights: s.weights || {} }));
                            setScenes(safeScenes);
                            if (!safeScenes.find(s => s.id === activeSceneId)) setActiveSceneId(safeScenes[0]?.id || 'scene-1');
                            alert("‚úÖ Ë≥áÊñôÂåØÂÖ•ÊàêÂäüÔºÅ");
                        } else { alert("‚ùå Ê™îÊ°àÊ†ºÂºèÈåØË™§„ÄÇ"); }
                    } catch (error) { alert("‚ùå ÂåØÂÖ•Â§±Êïó„ÄÇ"); }
                };
                reader.readAsText(fileObj);
                event.target.value = null;
            };

            const handleExportParticipants = () => {
                let csvContent = "\uFEFFÂêçÁ®±,ÈÉ®ÈñÄ\n";
                if (currentScene.participants.length > 0) { currentScene.participants.forEach(p => { csvContent += `${p.name},${p.group || '‰∏ÄËà¨'}\n`; }); } 
                else { csvContent += "ÁØÑ‰æãÁéãÂ∞èÊòé,Ê•≠ÂãôÈÉ®\n"; }
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `participants_${currentScene.title}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleImportParticipants = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const lines = text.split(/\r\n|\n/);
                    const newParticipants = [];
                    const newGroups = new Set(visibleGroups);
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line) {
                            const parts = line.split(',');
                            const name = parts[0]?.trim();
                            const group = parts[1]?.trim() || '‰∏ÄËà¨';
                            if (name) {
                                newParticipants.push({ id: Date.now() + Math.random() + i, name: name, group: group, active: true, won: false, bonusWon: false });
                                newGroups.add(group);
                            }
                        }
                    }
                    if (newParticipants.length > 0) {
                        setScenes(prev => prev.map(scene => {
                            if (scene.id !== activeSceneId) return scene;
                            return { ...scene, participants: [...scene.participants, ...newParticipants] };
                        }));
                        setVisibleGroups(newGroups);
                        alert(`‚úÖ ÊàêÂäüÂåØÂÖ• ${newParticipants.length} Á≠ÜÂêçÂñÆÔºÅ`);
                    } else { alert("‚ö†Ô∏è Ê™îÊ°à‰∏≠‰ºº‰πéÊ≤íÊúâÊúâÊïàË≥áÊñôÔºåË´ãÊ™¢Êü•Ê†ºÂºè„ÄÇ"); }
                };
                reader.readAsText(file);
                event.target.value = null;
            };

            const handleExportWinnersXlsx = () => {
                if (currentScene.history.length === 0) { alert("‚ö†Ô∏è ÁõÆÂâçÈÇÑÊ≤íÊúâ‰∏≠ÁçéÁ¥ÄÈåÑÂèØ‰ª•ÂåØÂá∫ÂñîÔºÅ"); return; }
                try {
                    const wb = XLSX.utils.book_new();
                    const allWinnersData = [["ÁçéÈ†ÖÂêçÁ®±", "ÂæóÁçéËÄÖ", "ÈÉ®ÈñÄ", "‰∏≠ÁçéÊôÇÈñì", "ÂÉπÂÄº"]];
                    let grandTotal = 0;
                    const sortedHistory = [...currentScene.history].reverse();
                    sortedHistory.forEach(h => { const val = parseInt(h.prizeValue) || 0; grandTotal += val; allWinnersData.push([h.prizeName, h.personName, h.personGroup || '', h.time, val]); });
                    allWinnersData.push([]); allWinnersData.push(["", "", "", "Á∏ΩË®àÈáëÈ°ç", grandTotal]);
                    const wsAll = XLSX.utils.aoa_to_sheet(allWinnersData);
                    wsAll['!cols'] = [{wch: 20}, {wch: 15}, {wch: 15}, {wch: 20}, {wch: 15}];
                    XLSX.utils.book_append_sheet(wb, wsAll, "Á∏ΩË¶Ω");
                    const prizesInHistory = [...new Set(currentScene.history.map(h => h.prizeName))];
                    prizesInHistory.forEach(prizeName => {
                        const winners = currentScene.history.filter(h => h.prizeName === prizeName);
                        const sheetData = [["È†ÖÊ¨°", "ÂßìÂêç", "‰∏≠ÁçéÈáëÈ°ç", "È†òÁçéÁ∞ΩÊî∂", "ÈùûÊ¶ÆÂØ¶‰∫∫Âì°Ë∫´ÂàÜË≠âÂ≠óËôü", "ÈùûÊ¶ÆÂØ¶‰∫∫Âì°Êà∂Á±çÂú∞ÂùÄ"]];
                        let prizeTotal = 0;
                        winners.forEach((w, index) => { const val = parseInt(w.prizeValue) || 0; prizeTotal += val; sheetData.push([index + 1, w.personName, val, "", "", ""]); });
                        sheetData.push([]); sheetData.push(["", "Êú¨È†ÅÁ∏ΩË®à", prizeTotal, "", "", ""]);
                        const ws = XLSX.utils.aoa_to_sheet(sheetData);
                        ws['!cols'] = [{wch: 8}, {wch: 15}, {wch: 15}, {wch: 20}, {wch: 25}, {wch: 40}];
                        const safeName = prizeName.replace(/[\\/?*\[\]]/g, '').substring(0, 30);
                        let sheetName = safeName; let counter = 1;
                        while (wb.SheetNames.includes(sheetName)) { sheetName = `${safeName.substring(0, 28)}_${counter}`; counter++; }
                        XLSX.utils.book_append_sheet(wb, ws, sheetName);
                    });
                    XLSX.writeFile(wb, `${currentScene.title}_‰∏≠ÁçéÂêçÂñÆ.xlsx`);
                } catch (error) { console.error("Export Error:", error); alert("ÂåØÂá∫Â§±Êïó„ÄÇ"); }
            };

            const triggerConfetti = () => {
                SoundManager.init();
                SoundManager.win();
                
                var duration = 3000;
                var animationEnd = Date.now() + duration;
                var defaults = { startVelocity: 40, spread: 360, ticks: 100, zIndex: 9999, scalar: 1.2 };
                function randomInRange(min, max) { return Math.random() * (max - min) + min; }
                var interval = setInterval(function() {
                    var timeLeft = animationEnd - Date.now();
                    if (timeLeft <= 0) return clearInterval(interval);
                    var particleCount = 50 * (timeLeft / duration);
                    confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
                    confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
                }, 250);
            };

            const getWeightedWinner = (candidates, prizeId) => {
                const weightsMap = currentScene.weights?.[prizeId] || {};
                let totalWeight = 0;
                const weightedCandidates = candidates.map(p => {
                    const weight = weightsMap[p.id] !== undefined ? weightsMap[p.id] : 1;
                    totalWeight += weight;
                    return { ...p, weight };
                });
                if (totalWeight <= 0) return null;
                let random = Math.random() * totalWeight;
                for (const p of weightedCandidates) {
                    if (random < p.weight) return p;
                    random -= p.weight;
                }
                return weightedCandidates[weightedCandidates.length - 1];
            };

            const startDraw = useCallback(() => {
                // Initialize audio context on user interaction
                SoundManager.init();
                // 1. Start continuous spin sound (if custom)
                SoundManager.startSpin();

                // 2. Calculate the VIEW pool (everyone visible)
                const visibleParticipants = currentScene.participants.filter(p => 
                    p.active && visibleGroups.has(p.group || 'Êú™ÂàÜÈ°û')
                );

                // 3. Calculate the ELIGIBLE candidates (for winning)
                // Âä†Á¢ºÈÇèËºØÔºöÂ¶ÇÊûúÊòØÂä†Á¢ºÁçéÈ†ÖÔºåÊ™¢Êü• bonusWonÔºõÂ¶ÇÊûúÊòØ‰∏ÄËà¨ÁçéÈ†ÖÔºåÊ™¢Êü• won
                const eligibleCandidates = visibleParticipants.filter(p => 
                    currentPrize.isBonus ? !p.bonusWon : !p.won
                );
                
                if (!currentPrize) { alert("üò± ÁõÆÂâçÊ≤íÊúâÁçéÈ†ÖÔºÅ"); return; }
                if (currentPrize.count <= 0) { alert("üò± ÈÄôÂÄãÁçéÈ†ÖÂ∑≤Á∂ìÊäΩÂÆå‰∫ÜÔºÅË´ãÈÅ∏ÊìáÂÖ∂‰ªñÁçéÈ†Ö„ÄÇ"); return; }
                if (eligibleCandidates.length === 0) { alert("‚ö†Ô∏è Ê≤íÊúâÁ¨¶ÂêàË≥áÊ†ºÁöÑÂèÉËàáËÄÖÔºÅ(Ë´ãÁ¢∫Ë™çÊòØÂê¶Â∑≤Âú®Ë®≠ÂÆö‰∏≠ÂãæÈÅ∏Â∞çÊáâÈÉ®ÈñÄ)"); return; }

                // Lock the grid view to ALL visible (including winners)
                setDrawPool(visibleParticipants); 
                setIsSpinning(true);
                setShowWinnerModal(false);
                setHighlightId(null);
                
                let counter = 0;
                const speed = 50; 
                
                timerRef.current = setInterval(() => {
                    // Randomly highlight ONLY eligible candidates
                    const randomIdx = Math.floor(Math.random() * eligibleCandidates.length);
                    setHighlightId(eligibleCandidates[randomIdx].id);
                    // Play tick ONLY if no custom sound is active (otherwise silence for BGM)
                    SoundManager.tick(); 
                    counter++;
                }, speed);

                setTimeout(() => {
                    clearInterval(timerRef.current);
                    // 4. Stop continuous spin sound immediately
                    SoundManager.stopSpin();
                    
                    const winner = getWeightedWinner(eligibleCandidates, currentPrize.id);
                    if (!winner) {
                        setIsSpinning(false);
                        alert("‚ö†Ô∏è ÊâÄÊúâÂÄôÈÅ∏‰∫∫ÁöÑ‰∏≠ÁçéÊ©üÁéáÁöÜÁÇ∫ 0ÔºåÁÑ°Ê≥ïÊäΩÂá∫Âæó‰∏ªÔºÅ");
                        return;
                    }
                    setHighlightId(winner.id);
                    setIsSpinning(false);
                    setLastWinner({ person: winner, prize: currentPrize });
                    
                    // 5. Play Win Sound & Confetti IMMEDIATELY (No delay)
                    triggerConfetti(); 
                    
                    // 6. Show Modal after a short delay (for visual confirmation)
                    setTimeout(() => {
                        setShowWinnerModal(true);
                    }, 800);
                }, 3000); 
            }, [currentScene, currentPrize, visibleGroups]);

            const confirmWin = useCallback(() => {
                if (!lastWinner?.person) return;
                SoundManager.confirm();
                
                const { person: winner, prize } = lastWinner;
                
                setScenes(prev => prev.map(scene => {
                    if (scene.id !== activeSceneId) return scene;
                    
                    const updatedParticipants = scene.participants.map(p => {
                        if (p.id === winner.id) {
                            if (prize.isBonus) {
                                return { ...p, bonusWon: true };
                            } else {
                                return { ...p, won: true };
                            }
                        }
                        return p;
                    });

                    const updatedPrizes = scene.prizes.map(p => 
                        p.id === prize.id ? { ...p, count: p.count - 1 } : p
                    );
                    const newHistory = [{
                        time: new Date().toLocaleTimeString('en-US', {hour12: false, hour: "numeric", minute: "numeric", second: "numeric"}),
                        personName: winner.name, 
                        personGroup: winner.group, 
                        prizeName: prize.name,
                        prizeId: prize.id, 
                        prizeValue: prize.value || 0
                    }, ...scene.history];
                    return { ...scene, participants: updatedParticipants, prizes: updatedPrizes, history: newHistory };
                }));
                setShowWinnerModal(false);
                setShowRedrawModal(false); 
                setHighlightId(null);
            }, [activeSceneId, lastWinner]);

            // ... (Redraw logic) ...
            
            // Toggle Redraw Group is not needed with new logic
            // Select All Redraw Groups is not needed with new logic

            const executeRedraw = useCallback((targetGroups) => {
                if (!currentPrize || currentPrize.count <= 0) { alert("üò± ÈÄôÂÄãÁçéÈ†ÖÂ∑≤Á∂ìÁôºÂÆå‰∫ÜÔºÅÁÑ°Ê≥ïÈáçÊäΩ„ÄÇ"); return; }
                
                setCurrentRedrawTarget(targetGroups);

                const isBonusDraw = currentPrize.isBonus;
                
                // 1. Calculate Display Pool (All active participants in selected groups)
                const displayPool = currentScene.participants.filter(p => 
                    p.active && targetGroups.has(p.group || 'Êú™ÂàÜÈ°û')
                );

                // 2. Calculate Eligible Candidates (Actual pool to draw from)
                const candidates = displayPool.filter(p => 
                    isBonusDraw ? !p.bonusWon : !p.won
                );

                if (candidates.length === 0) { alert(`‚ö†Ô∏è ÊâÄÈÅ∏Áæ§ÁµÑ‰∏≠Â∑≤Ê≤íÊúâÁ¨¶ÂêàË≥áÊ†ºÁöÑÂèÉËàáËÄÖÔºÅ`); return; }
                
                const winner = getWeightedWinner(candidates, currentPrize.id);
                // ‰øÆÊîπÔºöÁßªÈô§ alertÔºåËã•ÁÑ°Ë¥èÂÆ∂(Ê¨äÈáçÁöÜÁÇ∫0)ÂâáÁõ¥Êé•ËøîÂõû‰∏çÂãï‰Ωú
                if (!winner) { return; }

                setDrawPool(displayPool); // Update draw pool for the redraw grid (Here we only show eligible for focus)
                
                // --- NEW: Direct Redraw ---
                setShowWinnerModal(false); // Close winner modal if open
                setShowRedrawModal(true);  // Open redraw animation modal
                setIsRedrawSpinning(true);
                setHighlightId(null);
                setLastWinner({ person: winner, prize: currentPrize });
                
                // 1. Start continuous spin sound
                SoundManager.startSpin();

                if (timerRef.current) clearInterval(timerRef.current);
                timerRef.current = setInterval(() => {
                    const randomIdx = Math.floor(Math.random() * candidates.length);
                    setHighlightId(candidates[randomIdx].id); // Update highlight ID
                    setRedrawDisplay(candidates[randomIdx]); // Keep for text display if needed, but we use grid now
                    // 2. Play tick ONLY if no custom sound
                    SoundManager.tick();
                }, 50);

                setTimeout(() => {
                    clearInterval(timerRef.current);
                    // 3. Stop continuous spin sound
                    SoundManager.stopSpin();
                    
                    setHighlightId(winner.id); // Stop on winner
                    setRedrawDisplay(winner); 
                    setIsRedrawSpinning(false); 
                    triggerConfetti(); // Plays win sound
                }, 3000);
            }, [currentScene, currentPrize]);
            
            // Handle Redraw Click (Directly Execute)
            const handleRedrawClick = useCallback(() => { 
                // Directly execute using current visible groups as target
                executeRedraw(visibleGroups); 
            }, [visibleGroups, executeRedraw]);

            // Handle Retry Redraw
            const handleRetryRedraw = useCallback(() => {
                // If we are retrying, we just run executeRedraw again with the same target
                if (currentRedrawTarget) {
                    executeRedraw(currentRedrawTarget);
                } else {
                    executeRedraw(visibleGroups);
                }
            }, [currentRedrawTarget, visibleGroups, executeRedraw]);

            // --- Handlers for Prize Winners Modal ---
            const openPrizeWinners = (e, prize) => {
                e.stopPropagation();
                setViewingPrizeWinners(prize);
            };
            const closePrizeWinners = () => setViewingPrizeWinners(null);

            // ... (Other state helpers same as before) ...
            const toggleParticipantActive = (pId) => setScenes(prev => prev.map(s => s.id === activeSceneId ? {...s, participants: s.participants.map(p => p.id===pId?{...p, active:!p.active}:p)} : s));
            const deleteParticipant = (pId) => setScenes(prev => prev.map(s => s.id === activeSceneId ? {...s, participants: s.participants.filter(p => p.id!==pId)} : s));
            const handleAddNames = () => { if(!newNameList.trim())return; const names=newNameList.split('\n').filter(n=>n.trim()); const g=newGroupName.trim()||'‰∏ÄËà¨'; setScenes(prev=>prev.map(s=>s.id===activeSceneId?{...s, participants:[...s.participants, ...names.map(n=>({id:Date.now()+Math.random(), name:n.trim(), group:g, active:true, won:false, bonusWon:false}))]}:s)); setVisibleGroups(prev=>new Set(prev).add(g)); setNewNameList(''); };
            const handleAdminLogin = () => { if(adminPasswordInput==='355053'){setShowAdminLogin(false);setAdminPasswordInput('');setLoginError(false);setAdminTargetPrizeId(currentScene.prizes[0]?.id);setShowAdminPanel(true);}else{setLoginError(true);} };
            
            // Updated updateWeight: Can update bonus prize weight for non-bonus winners
            const updateWeight = (pid, w) => { 
                if(!adminTargetPrizeId)return; 
                setScenes(prev=>prev.map(s=>s.id===activeSceneId?{...s, weights:{...s.weights, [adminTargetPrizeId]:{...(s.weights[adminTargetPrizeId]||{}), [pid]:w}}}:s)); 
            };
            
            // Updated updateGroupWeights: Remove condition to allow forcing state even for winners (visual consistency)
            const updateGroupWeights = (ps, w) => { 
                if(!adminTargetPrizeId)return; 
                
                setScenes(prev=>prev.map(s=>{ 
                    if(s.id!==activeSceneId)return s; 
                    const newW={...s.weights}; 
                    if(!newW[adminTargetPrizeId])newW[adminTargetPrizeId]={}; 
                    ps.forEach(p=>{
                        // FIX: Remove the 'alreadyWon' check. 
                        // Allow "Turn All On/Off" to update weight for EVERYONE in the group.
                        // Eligibility is checked at draw time, so this is safe and allows easier bulk reset.
                        newW[adminTargetPrizeId][p.id]=w;
                    }); 
                    return {...s, weights:newW}; 
                })); 
            };
            
            const handleDragStart = (e, id) => { e.dataTransfer.setData("text/plain", id); e.target.classList.add("dragging"); };
            const handleDragEnd = (e) => { e.target.classList.remove("dragging"); setDragOverGroup(null); };
            const handleDragOver = (e, g) => { e.preventDefault(); setDragOverGroup(g); };
            const handleDrop = (e, g) => { e.preventDefault(); setDragOverGroup(null); const id=Number(e.dataTransfer.getData("text/plain")); if(!id)return; setScenes(prev=>prev.map(s=>s.id===activeSceneId?{...s, participants:s.participants.map(p=>p.id===id?{...p, group:g}:p)}:s)); };
            
            // --- Custom Sound Logic (Restored) ---
            const handleSoundUpload = (type, event) => {
                const file = event.target.files[0];
                if (!file) return;
                const url = URL.createObjectURL(file);
                if (type === 'spin') {
                    SoundManager.setCustomSpin(url);
                    setCustomSoundNames(prev => ({ ...prev, spin: file.name }));
                } else {
                    SoundManager.setCustomWin(url);
                    setCustomSoundNames(prev => ({ ...prev, win: file.name }));
                }
            };

            const handleResetSound = (type) => {
                if (type === 'spin') {
                    SoundManager.setCustomSpin(null);
                    setCustomSoundNames(prev => ({ ...prev, spin: '' }));
                    if (spinSoundInputRef.current) spinSoundInputRef.current.value = '';
                } else {
                    SoundManager.setCustomWin(null);
                    setCustomSoundNames(prev => ({ ...prev, win: '' }));
                    if (winSoundInputRef.current) winSoundInputRef.current.value = '';
                }
            };

            // --- New Drag & Drop Logic for Groups ---
            
            const handleGroupDragStart = (e, groupName) => {
                e.stopPropagation();
                e.dataTransfer.setData("application/lucky-draw-group", groupName);
                e.dataTransfer.effectAllowed = "move";
            };

            const handleGroupCardDrop = (e, targetGroupName) => {
                e.preventDefault();
                e.stopPropagation();
                setDragOverGroup(null);

                const draggedGroupName = e.dataTransfer.getData("application/lucky-draw-group");
                
                // Case 1: Reordering Groups
                if (draggedGroupName) {
                    if (draggedGroupName === targetGroupName) return;
                    
                    setScenes(prev => prev.map(scene => {
                        if (scene.id !== activeSceneId) return scene;
                        
                        // Extract groups in order
                        const currentGroups = [];
                        const groupMap = {};
                        scene.participants.forEach(p => {
                            const g = p.group || 'Êú™ÂàÜÈ°û';
                            if (!groupMap[g]) {
                                groupMap[g] = [];
                                currentGroups.push(g);
                            }
                            groupMap[g].push(p);
                        });
                        
                        const sourceIdx = currentGroups.indexOf(draggedGroupName);
                        const targetIdx = currentGroups.indexOf(targetGroupName);
                        
                        if (sourceIdx === -1 || targetIdx === -1) return scene;
                        
                        // Move group in the list
                        currentGroups.splice(sourceIdx, 1);
                        currentGroups.splice(targetIdx, 0, draggedGroupName);
                        
                        // Reconstruct participants array based on new group order
                        let newParticipants = [];
                        currentGroups.forEach(g => {
                            newParticipants = newParticipants.concat(groupMap[g]);
                        });
                        
                        return { ...scene, participants: newParticipants };
                    }));
                    return;
                }

                // Case 2: Moving Participant to Group (Existing logic)
                const id = Number(e.dataTransfer.getData("text/plain"));
                if (id) {
                    setScenes(prev => prev.map(s => 
                        s.id === activeSceneId 
                        ? { ...s, participants: s.participants.map(p => p.id === id ? { ...p, group: targetGroupName } : p) } 
                        : s
                    ));
                }
            };

            // Existing logic for reordering participants within a group
            const handleParticipantDragOver = (e) => {
                e.preventDefault(); 
                e.stopPropagation(); 
            };

            const handleParticipantDrop = (e, targetId) => {
                e.preventDefault();
                e.stopPropagation();
                
                const draggedId = Number(e.dataTransfer.getData("text/plain"));
                if (!draggedId || draggedId === targetId) return;

                setScenes(prev => prev.map(scene => {
                    if (scene.id !== activeSceneId) return scene;
                    
                    const list = [...scene.participants];
                    const dragIdx = list.findIndex(p => p.id === draggedId);
                    
                    if (dragIdx === -1) return scene;
                    
                    const [movedItem] = list.splice(dragIdx, 1);
                    const targetIdx = list.findIndex(p => p.id === targetId);
                    
                    if (targetIdx === -1) {
                        list.push(movedItem);
                    } else {
                        movedItem.group = list[targetIdx].group;
                        list.splice(targetIdx, 0, movedItem);
                    }
                    
                    return { ...scene, participants: list };
                }));
            };

            const addNewScene = () => { const id=`scene-${Date.now()}`; setScenes([...scenes, {id, title:`Êñ∞Ê¥ªÂãï`, participants:[], prizes:[], history:[], weights:{}}]); setActiveSceneId(id); };
            const deleteScene = (e, id) => { e.stopPropagation(); if(scenes.length===1)return; const ns=scenes.filter(s=>s.id!==id); setScenes(ns); if(activeSceneId===id)setActiveSceneId(ns[0].id); };
            const addPrize = () => { 
                if(!newPrizeName.trim()) return; 
                setScenes(prev=>prev.map(s=>s.id===activeSceneId?{...s, prizes:[...s.prizes, {id:Date.now(), name:newPrizeName, count:parseInt(newPrizeCount), value:parseInt(newPrizeValue)||0, isBonus:false}]} : s)); 
                setNewPrizeName(''); 
                setNewPrizeCount(1); 
                setNewPrizeValue(0); 
            };
            const updateSceneTitle = (t) => setScenes(prev=>prev.map(s=>s.id===activeSceneId?{...s, title:t}:s));
            const openEditPrize = (p) => setEditingPrize({...p});
            const closeEditPrize = () => setEditingPrize(null);
            const handleUpdatePrize = () => { if(!editingPrize)return; setScenes(prev=>prev.map(s=>s.id===activeSceneId?{...s, prizes:s.prizes.map(p=>p.id===editingPrize.id?{...p, name:editingPrize.name, count:parseInt(editingPrize.count), value:parseInt(editingPrize.value)||0, isBonus: editingPrize.isBonus}:p)}:s)); closeEditPrize(); };
            const handleDeletePrize = () => { if(!confirm("Delete?"))return; setScenes(prev=>prev.map(s=>s.id===activeSceneId?{...s, prizes:s.prizes.filter(p=>p.id!==editingPrize.id)}:s)); closeEditPrize(); if(selectedPrizeId===editingPrize.id)setSelectedPrizeId(null); };
            const handleAddBonus = () => { setScenes(prev=>prev.map(s=>s.id===activeSceneId?{...s, prizes:[...s.prizes, {id:Date.now(), name:bonusName, count:parseInt(bonusCount), value:parseInt(bonusAmount)||0, isBonus:true}]} : s)); setShowBonusModal(false); setBonusName('Âä†Á¢ºÁ¥ÖÂåÖ'); setBonusAmount(1000); setBonusCount(1); };

            // Keyboard
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.code === 'PageUp') {
                        e.preventDefault();
                        if (showRedrawModal && !isRedrawSpinning && currentRedrawTarget) { confirmWin(); return; } // Redraw result confirm
                        if (showWinnerModal && lastWinner && !showRedrawModal) { confirmWin(); return; } // Normal win confirm
                        if (!isSpinning && !showWinnerModal && !showRedrawModal && !showSettings && !showAdminLogin && !showAdminPanel && !showBonusModal) { startDraw(); return; } // Start draw
                    }
                    if (e.code === 'PageDown') {
                        e.preventDefault();
                        // Removed showRedrawMenu check
                        if (showWinnerModal && lastWinner && !showRedrawModal) { handleRedrawClick(); return; } // Re-draw
                        if (showRedrawModal && !isRedrawSpinning) { handleRetryRedraw(); return; } // Retry redraw
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [isSpinning, showWinnerModal, showRedrawModal, showSettings, showAdminLogin, showAdminPanel, showBonusModal, isRedrawSpinning, currentRedrawTarget, startDraw, confirmWin, handleRedrawClick, executeRedraw, handleRetryRedraw]);

            return (
                <div className="h-screen flex flex-col p-2 md:p-6 max-w-[95%] mx-auto w-full">
                    <input type="file" ref={fileInputRef} onChange={handleImport} style={{display: 'none'}} accept=".json" />
                    <input type="file" ref={participantsInputRef} onChange={handleImportParticipants} style={{display: 'none'}} accept=".csv" />

                    {/* Header */}
                    <div className="flex-none flex flex-wrap gap-3 mb-4 items-center">
                        <div className="text-3xl font-black text-red-600 mr-4 drop-shadow-sm select-none">
                            LUC<span onClick={() => { setShowAdminLogin(true); setLoginError(false); }} className="cursor-default">K</span>Y DRAW
                        </div>
                        {scenes.map(scene => (
                            <div key={scene.id} onClick={() => setActiveSceneId(scene.id)} className={`relative px-6 py-3 rounded-xl cursor-pointer transition-all flex items-center gap-2 font-bold shadow-md select-none ${activeSceneId === scene.id ? 'bg-gradient-to-br from-red-500 to-rose-600 text-white scale-105 shadow-red-300 ring-4 ring-red-200' : 'bg-white text-gray-500 hover:bg-red-50 hover:text-red-500'}`}>
                                {activeSceneId === scene.id ? ( <input value={scene.title} onChange={(e) => updateSceneTitle(e.target.value)} className="bg-transparent border-b-2 border-white/50 focus:border-white focus:outline-none w-24 sm:w-auto text-white placeholder-white/70" /> ) : ( <span>{scene.title}</span> )}
                                {activeSceneId === scene.id && scenes.length > 1 && ( <button onClick={(e) => deleteScene(e, scene.id)} className="text-white/70 hover:text-white ml-2 bg-black/10 rounded-full p-0.5"> <X size={14} /> </button> )}
                            </div>
                        ))}
                        <button onClick={addNewScene} className="w-10 h-10 flex items-center justify-center rounded-xl bg-white text-gray-400 hover:text-red-500 hover:bg-red-50 shadow-sm transition-all border-2 border-dashed border-gray-300 hover:border-red-300"> <Plus size={24} /> </button>
                        <div className="ml-auto flex gap-2">
                            {/* Undo/Redo Buttons */}
                            <button onClick={undo} disabled={history.past.length === 0} className={`p-2 rounded-lg transition ${history.past.length === 0 ? 'text-gray-300 cursor-not-allowed' : 'text-gray-500 hover:text-red-500 hover:bg-white hover:shadow-sm'}`} title="Âæ©Âéü"><Undo2 size={20}/></button>
                            <button onClick={redo} disabled={history.future.length === 0} className={`p-2 rounded-lg transition ${history.future.length === 0 ? 'text-gray-300 cursor-not-allowed' : 'text-gray-500 hover:text-red-500 hover:bg-white hover:shadow-sm'}`} title="ÈáçÂÅö"><Redo2 size={20}/></button>

                            <button onClick={() => fileInputRef.current.click()} className="flex items-center gap-2 bg-white text-gray-700 px-4 py-2.5 rounded-xl shadow-sm hover:bg-red-50 hover:text-red-500 transition-all font-bold border border-gray-200" title="ÂåØÂÖ•Ë®≠ÂÆö"><Upload size={18} /><span className="hidden sm:inline">ÂåØÂÖ•</span></button>
                            <button onClick={handleExport} className="flex items-center gap-2 bg-white text-gray-700 px-4 py-2.5 rounded-xl shadow-sm hover:bg-red-50 hover:text-red-500 transition-all font-bold border border-gray-200" title="ÂåØÂá∫Ë®≠ÂÆö"><Download size={18} /><span className="hidden sm:inline">ÂåØÂá∫</span></button>
                            
                            {/* Bonus Button Moved Here (Left of Settings) */}
                            <button 
                                onClick={() => setShowBonusModal(true)}
                                className="flex items-center gap-2 bg-orange-500 text-white px-4 py-2.5 rounded-xl shadow-lg hover:bg-orange-600 hover:scale-105 transition-all font-bold border border-orange-600"
                                title="Ëá®ÊôÇÂä†Á¢º (ÂÖ®È´îÂæ©Ê¥ª)"
                            >
                                <Coins size={18} /> Âä†Á¢º
                            </button>
                            
                            <button onClick={() => setShowSettings(true)} className="flex items-center gap-2 bg-red-600 text-white px-5 py-2.5 rounded-xl shadow-lg hover:bg-red-700 hover:scale-105 transition-all font-bold ring-2 ring-red-200"><Settings size={20} /><span>Ë®≠ÂÆö</span></button>
                        </div>
                    </div>

                    {/* Main Content Area */}
                    <main className="impact-panel flex-1 min-h-0 grid grid-cols-1 lg:grid-cols-12 gap-4 lg:gap-8 p-4 relative overflow-hidden">
                        
                        {/* 2. Middle: Grid Selection Display (8 Cols, taking left space) */}
                        <div className="lg:col-span-8 flex flex-col items-center h-full min-h-0 overflow-y-auto lg:overflow-hidden relative">
                            
                            {/* Grid Draw Area (Top) */}
                            <div className="flex-1 w-full bg-white/50 rounded-3xl border-4 border-red-200 p-4 relative overflow-hidden flex flex-col mb-4">
                                <div ref={mainGridRef} className="flex-1 overflow-y-auto custom-scrollbar content-center">
                                    {gridCandidates.length > 0 ? (
                                        <div className="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-12 gap-3 w-full">
                                            {gridCandidates.map(p => {
                                                const isHighlighted = p.id === highlightId;
                                                // Check winner status strictly for style
                                                const isWinner = currentPrize && currentPrize.isBonus ? p.bonusWon : p.won;
                                                
                                                return (
                                                    <div 
                                                        key={p.id}
                                                        id={`cell-${p.id}`}
                                                        className={`
                                                            aspect-square rounded-xl flex items-center justify-center p-1 shadow-sm transition-all duration-75 border-2
                                                            ${isWinner 
                                                                ? 'grid-cell-already-won' // Black bg, white text
                                                                : (isHighlighted 
                                                                    ? 'grid-cell-winner shadow-2xl border-yellow-500' // Gold highlight
                                                                    : 'grid-cell-normal border-red-300 opacity-90') // Normal Red
                                                            }
                                                        `}
                                                    >
                                                        {/* Adjusted Text Size for 12 cols: text-sm or text-base usually works best */}
                                                        <div className="font-black text-center whitespace-nowrap overflow-hidden text-ellipsis text-sm md:text-base lg:text-lg text-white leading-none w-full">
                                                            {p.name}
                                                        </div>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    ) : (
                                        <div className="h-full flex flex-col items-center justify-center text-gray-400">
                                            <span className="text-4xl opacity-30">üé∞</span>
                                            <p className="mt-2 font-bold">READY TO DRAW</p>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Prize Info (Bottom) - Swapped */}
                            <div className="flex-none mb-2 text-center w-full max-w-lg z-10">
                                {/* Label Removed to save space */}
                                <h2 className="text-5xl md:text-6xl font-black text-gray-800 flex items-center justify-center gap-4 drop-shadow-sm my-1 leading-relaxed py-1">
                                    <Gift className="text-red-500 w-12 h-12 md:w-16 md:h-16" strokeWidth={2.5} />
                                    <span className="">{currentPrize ? currentPrize.name : "‚Äî"}</span>
                                </h2>
                                <div className="flex justify-center gap-3 mt-2 flex-wrap">
                                    <span className="bg-green-600 text-white px-3 py-1 rounded-full text-sm font-bold shadow-md">Êú™‰∏≠Áçé: {currentScene.participants.filter(p => !p.won).length}</span>
                                    <span className="bg-blue-500 text-white px-3 py-1 rounded-full text-sm font-bold shadow-md">Á∏Ω‰∫∫Êï∏: {currentScene.participants.length}</span>
                                    <span className="bg-gray-800 text-white px-4 py-1 rounded-full text-sm font-bold shadow-md">Ââ©È§ò: {currentPrize ? currentPrize.count : 0}</span>
                                    {/* Added Value Display */}
                                    {currentPrize && currentPrize.value > 0 && <span className="bg-yellow-500 text-white px-4 py-1 rounded-full text-sm font-bold shadow-md">ÂÉπÂÄº: ${currentPrize.value.toLocaleString()}</span>}
                                </div>
                            </div>

                            {/* Start Button */}
                            <div className="flex-none w-full flex justify-center z-10">
                                <button onClick={startDraw} disabled={isSpinning || !currentPrize || currentPrize.count === 0} className={`w-full max-w-sm py-4 rounded-2xl text-2xl font-black shadow-[0_8px_0_0_rgba(0,0,0,0.2)] transform transition-all active:shadow-none active:translate-y-[8px] ${(isSpinning || !currentPrize || currentPrize.count === 0) ? 'bg-gray-300 text-gray-500 cursor-not-allowed shadow-none translate-y-[8px]' : 'bg-gradient-to-r from-red-500 to-rose-600 text-white hover:brightness-110 shadow-[0_8px_0_0_#9f1239]'}`}>{isSpinning ? 'SPINNING...' : (currentPrize && currentPrize.count === 0 ? 'ÁçéÈ†ÖÂ∑≤ÊäΩÂÆå' : 'ÈñãÂßãÊäΩÁçé !')}</button>
                            </div>
                        </div>

                        {/* 3. Right: Info Panel (4 Cols) - Same as before */}
                        <div className="lg:col-span-4 flex flex-col gap-4 h-full min-h-0">
                            {/* Prize List */}
                            <div className="flex-1 min-h-0 bg-white rounded-3xl p-1 shadow-inner border-2 border-red-100 flex flex-col">
                                <div className="bg-red-50 p-4 rounded-t-[20px] flex-none flex items-center justify-between border-b-2 border-red-100">
                                    <h3 className="font-black text-xl text-red-600 flex items-center gap-2"><Trophy size={24} className="text-yellow-500" /> ÁçéÈ†ÖÊ∏ÖÂñÆ PRIZES</h3>
                                    <span className="text-xs font-bold bg-red-200 text-red-700 px-2 py-1 rounded">{currentScene.prizes.reduce((acc, p) => acc + p.count, 0)} items left</span>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar">
                                    {currentScene.prizes.map((prize, idx) => {
                                        const isActivePrize = currentPrize && currentPrize.id === prize.id;
                                        return (
                                            <div key={prize.id} onClick={() => setSelectedPrizeId(prize.id)} className={`relative px-4 py-2 rounded-lg flex justify-between items-center transition-all cursor-pointer group ${prize.count === 0 ? 'bg-gray-100 border-2 border-gray-200 opacity-60 grayscale' : (isActivePrize ? 'selected-prize-card' : 'bg-white list-card-shadow')}`}>
                                                <div className="flex flex-col">
                                                    <span className={`font-black text-lg ${prize.count === 0 ? 'text-gray-500 line-through' : 'text-gray-800'}`}>{prize.name}</span>
                                                    {isActivePrize && prize.count > 0 && <span className="text-[10px] font-bold text-red-500 uppercase tracking-wider">Current Target</span>}
                                                    {/* Bonus Label */}
                                                    {prize.isBonus && <span className="text-[10px] font-bold text-orange-500 uppercase tracking-wider mt-0.5">Âä†Á¢º (Bonus)</span>}
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    {/* New: Prize Winners List Button */}
                                                    <button 
                                                        onClick={(e) => openPrizeWinners(e, prize)} 
                                                        className="p-1.5 rounded-lg text-gray-400 hover:text-blue-500 hover:bg-blue-50 transition-colors opacity-0 group-hover:opacity-100 mr-1"
                                                        title="ÂæóÁçéÂêçÂñÆ"
                                                    >
                                                        <UserList size={16} />
                                                    </button>

                                                    <div className={`w-10 h-8 flex items-center justify-center rounded-lg font-black text-lg shadow-sm ${prize.count > 0 ? 'bg-red-500 text-white' : 'bg-gray-300 text-gray-500'}`}>{prize.count}</div>
                                                    <button onClick={(e) => { e.stopPropagation(); openEditPrize(prize); }} className="p-1.5 rounded-lg text-gray-400 hover:text-red-500 hover:bg-red-50 transition-colors opacity-0 group-hover:opacity-100" title="‰øÆÊîπÁçéÈ†Ö"><Pencil size={16} /></button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                    {currentScene.prizes.length === 0 && <div className="h-full flex flex-col items-center justify-center text-gray-300"><Gift size={48} className="mb-2 opacity-20" /><p className="font-bold">Êö´ÁÑ°ÁçéÈ†Ö</p></div>}
                                </div>
                            </div>
                            {/* Winner History */}
                            <div className="flex-1 min-h-0 bg-red-50 rounded-3xl p-1 border-2 border-red-200 flex flex-col">
                                <div className="bg-red-100 p-4 rounded-t-[20px] flex-none border-b-2 border-red-200 flex justify-between items-center">
                                    <h3 className="font-black text-xl text-gray-600 flex items-center gap-2"><Users size={24} className="text-gray-500"/> {currentPrize ? `${currentPrize.name} Âæó‰∏ª` : '‰∏≠ÁçéÁ¥ÄÈåÑ'}</h3>
                                    <button onClick={handleExportWinnersXlsx} className="flex items-center gap-1 text-xs font-bold text-green-600 bg-green-100 hover:bg-green-200 px-3 py-1.5 rounded-lg transition" title="ÂåØÂá∫"><FileSpreadsheet size={16}/> ÂåØÂá∫ÂæóÁçéÂêçÂñÆ</button>
                                </div>
                                <ul className="flex-1 overflow-y-auto p-4 space-y-2">
                                    {currentScene.history.filter(record => !currentPrize || record.prizeId === currentPrize.id).map((record, idx) => (
                                        <li key={idx} className="flex items-center gap-3 p-3 bg-white rounded-xl shadow-sm border border-gray-100 animate-pop">
                                            <span className="font-mono text-xs text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded">{record.time}</span>
                                            <div className="flex flex-col flex-1">
                                                <span className="font-black text-lg text-gray-800 gold-text-impact">{record.personName}</span>
                                                {record.personGroup && <span className="text-xs text-gray-400 font-bold gold-text-impact">{record.personGroup}</span>}
                                            </div>
                                            <div className="flex flex-col items-end">
                                                <span className="text-xs font-bold bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full border border-yellow-200">{record.prizeName}</span>
                                                {record.prizeValue > 0 && <span className="text-[10px] text-gray-400 mt-1 font-bold">${record.prizeValue.toLocaleString()}</span>}
                                            </div>
                                        </li>
                                    ))}
                                    {currentScene.history.filter(record => !currentPrize || record.prizeId === currentPrize.id).length === 0 && (
                                        <div className="h-full flex flex-col items-center justify-center text-gray-300"><Users size={48} className="mb-2 opacity-20" /><p className="font-bold">{currentScene.history.length > 0 ? "Ê≠§ÁçéÈ†ÖÂ∞öÊú™ÊäΩÂá∫Âæó‰∏ª" : "Á≠âÂæÖÈñãÁçé..."}</p></div>
                                    )}
                                </ul>
                            </div>
                            <div className="bg-white rounded-2xl p-4 shadow-sm border-2 border-red-100 flex justify-between items-center mt-auto flex-none">
                                <div>
                                    <div className="text-gray-400 text-xs font-bold uppercase flex items-center gap-1"><Coins size={14}/> Á∏ΩË®àÈáëÈ°ç</div>
                                    <div className="text-2xl font-black text-gray-800">${totalAmount.toLocaleString()}</div>
                                </div>
                                <div className="text-right">
                                    <div className="text-red-500 text-xs font-bold uppercase">ÁõÆÂâçÊäΩÂá∫</div>
                                    <div className="text-2xl font-black text-red-600">${totalWonValue.toLocaleString()}</div>
                                </div>
                            </div>
                        </div>
                    </main>

                    {/* Modals... (Same as before) */}
                    {/* Bonus, Edit, Admin Login, Admin Panel, Settings, Redraw Menu, Small Redraw Modal, Main Winner Modal */}
                    
                    {/* NEW: Prize Winners List Modal */}
                    {viewingPrizeWinners && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={closePrizeWinners}>
                            <div className="bg-white rounded-2xl p-6 w-full max-w-lg shadow-2xl animate-pop border-4 border-blue-200 flex flex-col max-h-[80vh]" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-4">
                                    <h3 className="font-black text-2xl text-gray-800 flex items-center gap-2">
                                        <Trophy className="text-yellow-500" />
                                        {viewingPrizeWinners.name} ÂæóÁçéÂêçÂñÆ
                                    </h3>
                                    <button onClick={closePrizeWinners} className="p-2 hover:bg-gray-100 rounded-full transition"><X size={20}/></button>
                                </div>
                                <div className="overflow-y-auto flex-1 custom-scrollbar">
                                    {currentScene.history.filter(h => h.prizeId === viewingPrizeWinners.id).length > 0 ? (
                                        <table className="w-full text-left border-collapse">
                                            <thead>
                                                <tr className="text-gray-500 text-sm border-b">
                                                    <th className="py-2 px-2">ÂßìÂêç</th>
                                                    <th className="py-2 px-2">ÈÉ®ÈñÄ</th>
                                                    <th className="py-2 px-2 text-right">ÊôÇÈñì</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {currentScene.history
                                                    .filter(h => h.prizeId === viewingPrizeWinners.id)
                                                    .map((record, idx) => (
                                                        <tr key={idx} className="border-b border-gray-50 hover:bg-gray-50 transition">
                                                            <td className="py-3 px-2 font-bold text-gray-800">{record.personName}</td>
                                                            <td className="py-3 px-2 text-gray-500 text-sm">{record.personGroup || '-'}</td>
                                                            <td className="py-3 px-2 text-right text-gray-400 text-xs font-mono">{record.time}</td>
                                                        </tr>
                                                    ))}
                                            </tbody>
                                        </table>
                                    ) : (
                                        <div className="flex flex-col items-center justify-center py-10 text-gray-400">
                                            <Users size={48} className="mb-2 opacity-20" />
                                            <p>Â∞öÊú™ÊäΩÂá∫Âæó‰∏ª</p>
                                        </div>
                                    )}
                                </div>
                                <div className="mt-4 pt-4 border-t flex justify-end text-sm text-gray-500">
                                    ÂÖ± {currentScene.history.filter(h => h.prizeId === viewingPrizeWinners.id).length} ‰ΩçÂæó‰∏ª
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Bonus Prize Modal */}
                    {showBonusModal && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={() => setShowBonusModal(false)}>
                            <div className="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl animate-pop border-2 border-orange-200" onClick={e => e.stopPropagation()}>
                                <h3 className="font-black text-xl text-orange-600 mb-2 flex items-center gap-2"><Coins size={20}/> Ëá®ÊôÇÂä†Á¢ºË®≠ÂÆö</h3>
                                <p className="text-sm text-gray-500 mb-4">Ê≥®ÊÑèÔºöÂä†Á¢ºÁçéÈ†ÖÂ∞áÂÖÅË®±ÊâÄÊúâÂú®ËÅ∑‰∫∫Âì°ÈáçË§á‰∏≠Áçé (ÂÖ®È´îÂæ©Ê¥ª)„ÄÇ</p>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">ÁçéÈ†ÖÂêçÁ®±</label>
                                        <input 
                                            type="text" 
                                            className="w-full border-2 border-gray-200 rounded-lg p-2 font-bold text-gray-700 focus:border-orange-500 focus:outline-none"
                                            value={bonusName}
                                            onChange={e => setBonusName(e.target.value)}
                                        />
                                    </div>
                                    <div className="flex gap-4">
                                        <div className="flex-1">
                                            <label className="block text-xs font-bold text-gray-500 mb-1">ÈáëÈ°ç</label>
                                            <input 
                                                type="number" 
                                                className="w-full border-2 border-gray-200 rounded-lg p-2 font-bold text-gray-700 focus:border-orange-500 focus:outline-none"
                                                min="0"
                                                value={bonusAmount}
                                                onChange={e => setBonusAmount(e.target.value)}
                                            />
                                        </div>
                                        <div className="flex-1">
                                            <label className="block text-xs font-bold text-gray-500 mb-1">Êï∏Èáè</label>
                                            <input 
                                                type="number" 
                                                className="w-full border-2 border-gray-200 rounded-lg p-2 font-bold text-gray-700 focus:border-orange-500 focus:outline-none"
                                                min="1"
                                                value={bonusCount}
                                                onChange={e => setBonusCount(e.target.value)}
                                            />
                                        </div>
                                    </div>
                                </div>
                                <div className="flex gap-3 mt-6">
                                    <button onClick={() => setShowBonusModal(false)} className="bg-gray-100 text-gray-600 px-4 py-2 rounded-lg font-bold hover:bg-gray-200 transition flex-1">ÂèñÊ∂à</button>
                                    <button onClick={handleAddBonus} className="bg-orange-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-orange-600 transition shadow-md flex-1">Á¢∫Ë™çÂä†Á¢º</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Edit Prize Modal */}
                    {editingPrize && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={closeEditPrize}>
                            <div className="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl animate-pop border-2 border-red-200" onClick={e => e.stopPropagation()}>
                                <h3 className="font-black text-xl text-gray-800 mb-4 flex items-center gap-2"><Pencil size={20}/> ‰øÆÊîπÁçéÈ†Ö</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">ÁçéÈ†ÖÂêçÁ®±</label>
                                        <input type="text" className="w-full border-2 border-gray-200 rounded-lg p-2 font-bold text-gray-700 focus:border-red-500 focus:outline-none" value={editingPrize.name} onChange={e => setEditingPrize({...editingPrize, name: e.target.value})} />
                                    </div>
                                    <div className="flex gap-4">
                                        <div className="flex-1">
                                            <label className="block text-xs font-bold text-gray-500 mb-1">ÈáëÈ°ç</label>
                                            <input type="number" className="w-full border-2 border-gray-200 rounded-lg p-2 font-bold text-gray-700 focus:border-red-500 focus:outline-none" min="0" value={editingPrize.value} onChange={e => setEditingPrize({...editingPrize, value: e.target.value})} />
                                        </div>
                                        <div className="flex-1">
                                            <label className="block text-xs font-bold text-gray-500 mb-1">Êï∏Èáè</label>
                                            <input type="number" className="w-full border-2 border-gray-200 rounded-lg p-2 font-bold text-gray-700 focus:border-red-500 focus:outline-none" min="0" value={editingPrize.count} onChange={e => setEditingPrize({...editingPrize, count: e.target.value})} />
                                        </div>
                                    </div>
                                    {/* Checkbox for Bonus Prize */}
                                    {/* ÁßªÈô§ÊâãÂãïÂãæÈÅ∏‰ªãÈù¢ÔºåÈÅøÂÖçÊ∑∑Ê∑Ü */}
                                </div>
                                <div className="flex gap-3 mt-6">
                                    <button onClick={handleDeletePrize} className="bg-red-100 text-red-600 px-4 py-2 rounded-lg font-bold hover:bg-red-200 transition">Âà™Èô§</button>
                                    <div className="flex-1"></div>
                                    <button onClick={closeEditPrize} className="bg-gray-100 text-gray-600 px-4 py-2 rounded-lg font-bold hover:bg-gray-200 transition">ÂèñÊ∂à</button>
                                    <button onClick={handleUpdatePrize} className="bg-red-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-red-600 transition shadow-md">ÂÑ≤Â≠ò</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Admin Login */}
                    {showAdminLogin && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-md flex items-center justify-center z-50 p-4" onClick={() => setShowAdminLogin(false)}>
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-pop border-2 border-gray-800" onClick={e => e.stopPropagation()}>
                                <h3 className="font-black text-xl text-gray-800 mb-4 flex items-center gap-2"><Shield size={20}/> ÁÆ°ÁêÜÂì°ÁôªÂÖ•</h3>
                                <input type="password" placeholder="Ë´ãËº∏ÂÖ•ÂØÜÁ¢º" className={`w-full border-2 rounded-lg p-3 text-center mb-2 focus:outline-none font-bold transition-all ${loginError ? 'border-red-500 bg-red-50 text-red-600' : 'border-gray-300 focus:border-gray-800'}`} value={adminPasswordInput} onChange={e => { setAdminPasswordInput(e.target.value); if(loginError) setLoginError(false); }} autoFocus onKeyDown={(e) => e.key === 'Enter' && handleAdminLogin()} />
                                <div className={`text-red-500 text-sm font-bold text-center mb-4 h-5 ${loginError ? 'opacity-100 animate-shake' : 'opacity-0'}`}>{loginError ? <span className="flex items-center justify-center gap-1"><AlertTriangle size={14}/> ÂØÜÁ¢ºÈåØË™§ÔºåË´ãÈáçË©¶ÔºÅ</span> : ''}</div>
                                <div className="flex gap-3">
                                    <button onClick={handleAdminLogin} className="flex-1 bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 transition shadow-md">ÁôªÂÖ•</button>
                                    <button onClick={() => setShowAdminLogin(false)} className="flex-1 bg-red-500 text-white py-3 rounded-lg font-bold hover:bg-red-600 transition shadow-md">ÂèñÊ∂à</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Admin Panel */}
                    {showAdminPanel && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-md flex items-center justify-center z-50 p-4" onClick={() => setShowAdminPanel(false)}>
                            <div className="bg-white rounded-3xl w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl animate-pop overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="p-5 border-b flex justify-between items-center bg-gray-900 text-white">
                                    <h2 className="font-black text-2xl flex items-center gap-2"><Shield className="text-yellow-400"/> Ê©üÁéáÊéßÂà∂Âè∞</h2>
                                    <button onClick={() => setShowAdminPanel(false)} className="p-2 hover:bg-gray-700 rounded-full transition"><X/></button>
                                </div>
                                <div className="p-6 bg-gray-100 flex items-center gap-4 border-b">
                                    <span className="font-bold text-gray-700">Ë®≠ÂÆöÁõÆÊ®ôÁçéÈ†ÖÔºö</span>
                                    <select className="p-2 rounded-lg border-2 border-gray-300 font-bold flex-1 max-w-md" value={adminTargetPrizeId || ''} onChange={(e) => setAdminTargetPrizeId(parseInt(e.target.value))}>
                                        {currentScene.prizes.map(p => ( <option key={p.id} value={p.id}>{p.name} (Ââ©È§ò {p.count})</option> ))}
                                    </select>
                                </div>
                                <div className="p-6 overflow-y-auto flex-1 space-y-6">
                                    {Object.entries(groupedParticipants).map(([groupName, participants]) => (
                                        <div key={groupName} className="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                                            <div className="bg-gray-50 px-4 py-2 font-bold text-gray-700 flex items-center gap-2 border-b"><Building size={16}/> {groupName}
                                                <div className="ml-auto flex gap-2">
                                                    <button onClick={() => updateGroupWeights(participants, 1)} className="text-xs bg-green-100 text-green-600 px-2 py-1 rounded hover:bg-green-200 transition font-bold border border-green-200">ÂÖ®Èñã</button>
                                                    <button onClick={() => updateGroupWeights(participants, 0)} className="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded hover:bg-gray-300 transition font-bold border border-gray-300">ÂÖ®Èóú</button>
                                                </div>
                                            </div>
                                            <div className="p-2 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2">
                                                {participants.map(p => {
                                                    const weight = currentScene.weights?.[adminTargetPrizeId]?.[p.id] !== undefined ? currentScene.weights[adminTargetPrizeId][p.id] : 1;
                                                    const isOn = weight > 0;
                                                    
                                                    // Determine exclusion based on prize type
                                                    const targetPrizeInPanel = currentScene.prizes.find(p => p.id === adminTargetPrizeId);
                                                    const isTargetBonus = targetPrizeInPanel?.isBonus;
                                                    const isExcluded = isTargetBonus ? p.bonusWon : p.won;

                                                    return (
                                                        <div key={p.id} className={`flex items-center justify-between p-3 rounded-lg border-2 transition-colors ${isOn ? 'bg-white border-gray-100' : 'bg-gray-50 border-gray-200'}`}>
                                                            <span className={`font-bold truncate mr-2 ${isExcluded ? 'text-gray-400 line-through' : (isOn ? 'text-gray-800' : 'text-gray-400')}`}>{p.name}</span>
                                                            <button onClick={() => !isExcluded && updateWeight(p.id, isOn ? 0 : 1)} disabled={isExcluded} className={`relative w-16 h-8 rounded-full transition-all duration-300 shadow-inner flex items-center shrink-0 focus:outline-none ${isOn ? 'bg-green-500' : 'bg-gray-300'} ${isExcluded ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:brightness-110'}`}>
                                                                <span className={`absolute left-2 text-[10px] font-black text-white transition-opacity ${isOn ? 'opacity-100' : 'opacity-0'}`}>ON</span>
                                                                <span className={`absolute right-2 text-[10px] font-black text-gray-500 transition-opacity ${isOn ? 'opacity-0' : 'opacity-100'}`}>OFF</span>
                                                                <div className={`w-6 h-6 bg-white rounded-full shadow-md transform transition-transform duration-300 absolute top-1 left-1 flex items-center justify-center ${isOn ? 'translate-x-8' : 'translate-x-0'}`}>
                                                                    <div className={`w-2 h-2 rounded-full transition-colors ${isOn ? 'bg-green-500' : 'bg-gray-400'}`}></div>
                                                                </div>
                                                            </button>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="p-4 bg-gray-50 text-center text-sm text-gray-500 font-bold border-t">Ë®≠ÂÆöË™™ÊòéÔºöÂàáÊèõÁÇ∫ <span className="text-green-600">ON</span> Ë°®Á§∫ÊúâÊ©üÊúÉ‰∏≠ÁçéÔºõ<span className="text-gray-400">OFF</span> ÂâáÁµïÂ∞ç‰∏çÊúÉ‰∏≠Ë©≤ÁçéÈ†Ö (Ê¨äÈáçË®≠ÁÇ∫ 0)„ÄÇ</div>
                            </div>
                        </div>
                    )}

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={() => setShowSettings(false)}>
                            <div className="bg-white rounded-3xl w-full max-w-2xl max-h-[85vh] flex flex-col shadow-2xl animate-pop overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="p-5 border-b flex justify-between items-center bg-gray-50">
                                    <h2 className="font-black text-2xl text-gray-800 flex items-center gap-2">Ë®≠ÂÆö / Settings</h2>
                                    <button onClick={() => setShowSettings(false)} className="p-2 hover:bg-gray-200 rounded-full transition"><X/></button>
                                </div>
                                <div className="p-8 overflow-y-auto flex-1 space-y-8">
                                    {/* Sound Settings Block */}
                                    <div className="bg-gray-50 p-4 rounded-xl border-2 border-gray-100">
                                        <h3 className="font-bold text-gray-900 mb-3 flex items-center gap-2"><Volume2 size={18}/> Èü≥ÊïàË®≠ÂÆö</h3>
                                        <div className="space-y-4">
                                            {/* Spin Sound */}
                                            <div className="flex items-center justify-between">
                                                <div className="flex flex-col">
                                                    <span className="text-sm font-bold text-gray-700">ËΩâÂãïÈü≥Êïà</span>
                                                    <span className="text-xs text-gray-400">Âª∫Ë≠∞‰ΩøÁî®Áü≠‰øÉÈü≥Êïà (Â¶Ç: Âïµ„ÄÅÂèÆ)</span>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <input 
                                                        type="file" 
                                                        accept="audio/*" 
                                                        ref={spinSoundInputRef}
                                                        className="hidden"
                                                        onChange={(e) => handleSoundUpload('spin', e)}
                                                    />
                                                    <span className="text-xs text-gray-500 font-medium mr-2 truncate max-w-[100px]">
                                                        {customSoundNames.spin || "È†êË®≠Èü≥Êïà"}
                                                    </span>
                                                    <button 
                                                        onClick={() => spinSoundInputRef.current.click()} 
                                                        className="bg-white border border-gray-300 text-gray-700 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-gray-50 transition"
                                                    >
                                                        ‰∏äÂÇ≥
                                                    </button>
                                                    <button 
                                                        onClick={() => SoundManager.spin()} 
                                                        className="bg-blue-100 text-blue-600 p-1.5 rounded-lg hover:bg-blue-200 transition"
                                                        title="Ë©¶ËÅΩ"
                                                    >
                                                        <Play size={14} fill="currentColor" />
                                                    </button>
                                                    {customSoundNames.spin && (
                                                        <button 
                                                            onClick={() => handleResetSound('spin')}
                                                            className="text-red-400 hover:text-red-600 p-1"
                                                            title="ÈáçÁΩÆ"
                                                        >
                                                            <X size={14} />
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            {/* Win Sound */}
                                            <div className="flex items-center justify-between border-t border-gray-200 pt-4">
                                                <div className="flex flex-col">
                                                    <span className="text-sm font-bold text-gray-700">‰∏≠ÁçéÈü≥Êïà</span>
                                                    <span className="text-xs text-gray-400">‰∏≠ÁçéÊôÇÊí≠ÊîæÁöÑÊÖ∂Á•ùÈü≥Êïà</span>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <input 
                                                        type="file" 
                                                        accept="audio/*" 
                                                        ref={winSoundInputRef}
                                                        className="hidden"
                                                        onChange={(e) => handleSoundUpload('win', e)}
                                                    />
                                                    <span className="text-xs text-gray-500 font-medium mr-2 truncate max-w-[100px]">
                                                        {customSoundNames.win || "È†êË®≠Èü≥Êïà"}
                                                    </span>
                                                    <button 
                                                        onClick={() => winSoundInputRef.current.click()} 
                                                        className="bg-white border border-gray-300 text-gray-700 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-gray-50 transition"
                                                    >
                                                        ‰∏äÂÇ≥
                                                    </button>
                                                    <button 
                                                        onClick={() => SoundManager.win()} 
                                                        className="bg-blue-100 text-blue-600 p-1.5 rounded-lg hover:bg-blue-200 transition"
                                                        title="Ë©¶ËÅΩ"
                                                    >
                                                        <Play size={14} fill="currentColor" />
                                                    </button>
                                                    {customSoundNames.win && (
                                                        <button 
                                                            onClick={() => handleResetSound('win')}
                                                            className="text-red-400 hover:text-red-600 p-1"
                                                            title="ÈáçÁΩÆ"
                                                        >
                                                            <X size={14} />
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <div className="flex justify-between items-center mb-3">
                                            <h3 className="font-bold text-gray-900 flex items-center gap-2"><Plus size={18}/> Âø´ÈÄüÊñ∞Â¢û‰∫∫Âì°</h3>
                                            <div className="flex gap-2">
                                                <button onClick={handleExportParticipants} className="flex items-center gap-1 text-xs font-bold text-red-600 border border-red-200 bg-red-50 hover:bg-red-100 px-3 py-1.5 rounded-lg transition" title="‰∏ãËºâÁõÆÂâçÁöÑ CSVÔºåÂèØÁî®Êñº Excel Á∑®ËºØ"><Download size={14}/> ÂåØÂá∫ÂêçÂñÆ (Âê´Ê†ºÂºè)</button>
                                                <button onClick={() => participantsInputRef.current.click()} className="flex items-center gap-1 text-xs font-bold text-white bg-red-500 hover:bg-red-600 px-3 py-1.5 rounded-lg transition shadow-sm" title="‰∏äÂÇ≥ CSV Ê™îÊ°àÂä†ÂÖ•ÂêçÂñÆ"><Upload size={14}/> ÂåØÂÖ•ÂêçÂñÆ</button>
                                            </div>
                                        </div>
                                        <div className="flex flex-col gap-3 bg-gray-50 p-4 rounded-xl border-2 border-gray-100">
                                            <div className="flex items-center gap-2">
                                                <span className="text-sm font-bold text-gray-500">ÈÉ®ÈñÄ/Áæ§ÁµÑ:</span>
                                                <input type="text" className="border-2 border-gray-200 rounded-lg p-2 text-sm w-40 focus:border-red-500 focus:outline-none" placeholder="‰æãÂ¶Ç: Ê•≠ÂãôÈÉ®" value={newGroupName} onChange={e => setNewGroupName(e.target.value)} />
                                            </div>
                                            <div className="flex gap-3">
                                                <textarea className="w-full border-2 border-gray-200 rounded-xl p-3 text-sm focus:border-red-500 focus:outline-none transition-colors" rows="3" placeholder="Ë≤º‰∏äÂêçÂñÆÔºå‰∏ÄË°å‰∏ÄÂÄãÂêçÂ≠ó..." value={newNameList} onChange={e => setNewNameList(e.target.value)}></textarea>
                                                <button onClick={handleAddNames} className="bg-gray-900 text-white px-6 rounded-xl font-bold hover:bg-black whitespace-nowrap shadow-lg">Êñ∞Â¢û</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h3 className="font-bold text-gray-900 mb-3 flex items-center gap-2"><Gift size={18}/> Êñ∞Â¢ûÁçéÈ†Ö</h3>
                                        <div className="bg-gray-50 p-4 rounded-xl border-2 border-gray-100">
                                            <div className="flex gap-2 mb-2">
                                                <div className="flex-1">
                                                    <label className="text-xs text-gray-500 font-bold ml-1">ÁçéÈ†ÖÂêçÁ®±</label>
                                                    <input type="text" placeholder="‰æã: È†≠Áçé" className="w-full border-2 border-gray-200 p-2 rounded-lg focus:border-red-500 focus:outline-none font-bold text-gray-700" value={newPrizeName} onChange={e => setNewPrizeName(e.target.value)} />
                                                </div>
                                                <div className="w-24">
                                                    <label className="text-xs text-gray-500 font-bold ml-1">ÈáëÈ°ç</label>
                                                    <input type="number" placeholder="0" className="w-full border-2 border-gray-200 p-2 rounded-lg focus:border-red-500 focus:outline-none font-bold text-center" min="0" value={newPrizeValue} onChange={e => setNewPrizeValue(e.target.value)} />
                                                </div>
                                                <div className="w-20">
                                                    <label className="text-xs text-gray-500 font-bold ml-1">Êï∏Èáè</label>
                                                    <input type="number" placeholder="1" className="w-full border-2 border-gray-200 p-2 rounded-lg focus:border-red-500 focus:outline-none font-bold text-center" min="1" value={newPrizeCount} onChange={e => setNewPrizeCount(e.target.value)} />
                                                </div>
                                            </div>
                                            <div className="flex justify-between items-center mt-2">
                                                <div className="text-gray-400 text-xs font-bold">È†ê‰º∞Á∏ΩÈ°ç: <span className="text-gray-600">${((parseInt(newPrizeValue) || 0) * (parseInt(newPrizeCount) || 0)).toLocaleString()}</span></div>
                                                <button onClick={addPrize} className="bg-yellow-400 text-yellow-900 px-6 py-2 rounded-lg font-black hover:bg-yellow-500 whitespace-nowrap shadow-md uppercase tracking-wide text-sm">Êñ∞Â¢ûÁçéÈ†Ö</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <div className="flex justify-between items-end mb-4">
                                            <div>
                                                <h3 className="font-bold text-gray-900">ÂêçÂñÆÁÆ°ÁêÜ</h3>
                                                <span className="text-xs font-bold bg-gray-200 px-2 py-1 rounded text-gray-600">{currentScene.participants.length} ‰∫∫</span>
                                            </div>
                                            <button onClick={toggleAllGroups} className="text-xs font-bold text-red-500 hover:text-red-600 underline">{visibleGroups.size === Object.keys(groupedParticipants).length ? 'ÂÖ®ÈÉ®Êî∂Ëµ∑' : 'ÂÖ®ÈÉ®È°ØÁ§∫'}</button>
                                        </div>
                                        <div className="flex flex-wrap gap-2 mb-6 p-3 bg-gray-50 border-2 border-gray-100 rounded-xl">
                                            {Object.keys(groupedParticipants).length === 0 && <div className="text-gray-400 text-sm">Êö´ÁÑ°Áæ§ÁµÑ</div>}
                                            {Object.keys(groupedParticipants).map(groupName => (
                                                <button 
                                                    key={groupName} 
                                                    draggable="true"
                                                    onDragStart={(e) => handleGroupDragStart(e, groupName)}
                                                    onDragOver={(e) => e.preventDefault()}
                                                    onDrop={(e) => handleGroupCardDrop(e, groupName)}
                                                    onClick={() => toggleGroupVisibility(groupName)} 
                                                    className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold transition-all border cursor-move ${visibleGroups.has(groupName) ? 'bg-red-500 text-white border-red-500 shadow-md transform scale-105' : 'bg-white text-gray-500 border-gray-300 hover:border-red-300'}`}
                                                    title="ÂèØÊãñÊõ≥Ë™øÊï¥È†ÜÂ∫è"
                                                >
                                                    {visibleGroups.has(groupName) ? <CheckCircle size={12} className="text-white"/> : <div className="w-3 h-3 rounded-full border border-gray-400"></div>}
                                                    {groupName}
                                                </button>
                                            ))}
                                        </div>
                                        <div className="space-y-6">
                                            {Object.entries(groupedParticipants)
                                                .filter(([groupName]) => visibleGroups.has(groupName))
                                                .map(([groupName, participants]) => (
                                                <div 
                                                    key={groupName} 
                                                    className={`bg-white rounded-xl border-2 overflow-hidden transition-all animate-pop cursor-grab active:cursor-grabbing ${dragOverGroup === groupName ? 'drag-over' : 'border-gray-100'}`}
                                                    draggable="true"
                                                    onDragStart={(e) => handleGroupDragStart(e, groupName)}
                                                    onDragOver={(e) => handleDragOver(e, groupName)} 
                                                    onDrop={(e) => handleGroupCardDrop(e, groupName)}
                                                >
                                                    <div className="bg-gray-50 px-4 py-2 font-black text-gray-700 flex items-center gap-2 border-b-2 border-gray-100">
                                                        <GripVertical size={16} className="text-gray-400 cursor-grab" />
                                                        <Building size={16} className="text-red-500"/>
                                                        {groupName}
                                                        <span className="text-xs font-normal text-gray-400 ml-auto">{participants.length} ‰∫∫</span>
                                                    </div>
                                                    <div className="p-3 grid grid-cols-2 sm:grid-cols-3 gap-3">
                                                        {participants.map(p => (
                                                            <div 
                                                                key={p.id} 
                                                                draggable="true" 
                                                                onDragStart={(e) => handleDragStart(e, p.id)} 
                                                                onDragEnd={(e) => { e.target.classList.remove("dragging"); setDragOverGroup(null); }}
                                                                onDragOver={handleParticipantDragOver}
                                                                onDrop={(e) => handleParticipantDrop(e, p.id)}
                                                                className={`flex items-center gap-2 p-2 rounded-lg border-2 transition-all relative group cursor-move ${p.won ? 'bg-gray-100 border-gray-100 opacity-50' : 'bg-white border-gray-100 hover:border-red-200 hover:shadow-sm'}`}
                                                            >
                                                                <div className="flex items-center gap-2 flex-1 min-w-0">
                                                                    <input type="checkbox" checked={p.active} disabled={p.won} onChange={() => toggleParticipantActive(p.id)} className="w-4 h-4 accent-red-600 rounded shrink-0 cursor-pointer" onClick={(e) => e.stopPropagation()} />
                                                                    <span className={`font-bold truncate text-sm ${!p.active ? 'line-through text-gray-400' : 'text-gray-700'}`}>{p.name}</span>
                                                                </div>
                                                                {!p.won && (
                                                                    <button onClick={(e) => { e.stopPropagation(); deleteParticipant(p.id); }} className="text-gray-300 hover:text-red-500 p-1 rounded-full hover:bg-red-50 transition-colors shrink-0" title="ÁßªÈô§Ê≠§‰∫∫">
                                                                        <X size={14} strokeWidth={3}/>
                                                                    </button>
                                                                )}
                                                                {p.won && <span className="text-[10px] font-black bg-gray-600 text-white px-1 py-0.5 rounded shrink-0">WIN</span>}
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                            {currentScene.participants.length > 0 && visibleGroups.size === 0 && (
                                                <div className="text-center py-8 text-gray-400 font-bold border-2 border-dashed border-gray-200 rounded-xl">Ë´ãÂãæÈÅ∏‰∏äÊñπÁæ§ÁµÑ‰ª•Ê™¢Ë¶ñÂêçÂñÆ</div>
                                            )}
                                            {currentScene.participants.length === 0 && <div className="text-center text-gray-400 py-4">ÁõÆÂâçÊ≤íÊúâÂêçÂñÆ</div>}
                                        </div>
                                    </div>
                                </div>
                                <div className="p-4 border-t bg-gray-50 flex justify-between items-center">
                                    <button onClick={() => { setShowSettings(false); handleRedrawClick(); }} className="flex items-center gap-2 px-6 py-3 bg-white border-2 border-pink-200 text-red-600 rounded-xl hover:bg-pink-50 font-bold shadow-sm transition"><RefreshCw size={18}/> ÈáçÊäΩÊ®°Âºè</button>
                                    <button onClick={() => setShowSettings(false)} className="px-8 py-3 bg-gray-900 text-white rounded-xl hover:bg-black font-bold shadow-lg">ÂÆåÊàêË®≠ÂÆö</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Small Redraw Modal */}
                    {showRedrawModal && (
                        <div className="fixed inset-0 bg-black/90 backdrop-blur-lg flex items-center justify-center z-50 p-4" onClick={() => {}}>
                            <div className="bg-white rounded-[32px] md:rounded-[50px] w-full max-w-[95%] max-h-[90vh] flex flex-col relative shadow-[0_0_150px_rgba(239,68,68,0.6)] animate-pop rainbow-border overflow-visible transition-transform duration-300" style={{transform: 'scale(0.97)'}} onClick={e => e.stopPropagation()}>
                                <div className="absolute -top-10 md:-top-16 left-1/2 -translate-x-1/2 bg-red-500 rounded-full p-3 md:p-5 border-[4px] md:border-[6px] border-white shadow-2xl z-20">
                                    <RefreshCw size={36} className="text-white md:hidden animate-spin-slow" />
                                    <RefreshCw size={72} className="text-white hidden md:block animate-spin-slow" />
                                </div>
                                <div ref={redrawGridRef} className="overflow-y-auto px-4 md:px-10 py-5 md:py-8 flex-1 custom-scrollbar mt-6 md:mt-8 rounded-[40px] flex flex-col items-center w-full">
                                    <div className="text-red-400 font-black uppercase tracking-widest text-sm md:text-xl mb-2 md:mb-4 mt-4 md:mt-0">
                                        {isRedrawSpinning ? "REROLLING..." : "NEW WINNER!"}
                                    </div>
                                    {isRedrawSpinning ? (
                                        /* Redraw Grid Animation */
                                        <div className="w-full grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-12 gap-3 p-4 bg-white/50 rounded-3xl border-4 border-red-200">
                                            {/* Show current draw pool */}
                                            {drawPool.map(p => {
                                                const isHighlighted = p.id === highlightId;
                                                const isWinner = currentPrize && currentPrize.isBonus ? p.bonusWon : p.won;
                                                return (
                                                    <div 
                                                        key={p.id}
                                                        id={`redraw-cell-${p.id}`} // Change for redraw
                                                        className={`
                                                            aspect-square rounded-xl flex items-center justify-center p-1 shadow-sm transition-all duration-75 border-2
                                                            ${isWinner 
                                                                ? 'grid-cell-already-won' // Black bg, white text
                                                                : (isHighlighted 
                                                                    ? 'grid-cell-winner shadow-2xl border-yellow-500' 
                                                                    : 'grid-cell-normal border-red-300 opacity-90') 
                                                            }
                                                        `}
                                                    >
                                                        {/* ‰øÆÊîπÔºöÂ≠óÈ´îË™øÊï¥ÁÇ∫Ëàá‰∏ªÁï´Èù¢‰∏ÄËá¥ text-sm md:text-base lg:text-lg */}
                                                        <div className="font-black text-center whitespace-nowrap overflow-hidden text-ellipsis text-sm md:text-base lg:text-lg text-white leading-none w-full">
                                                            {p.name}
                                                        </div>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    ) : (
                                        /* Redraw Winner Result */
                                        <div className="w-full flex flex-col items-center animate-pop flex-1 justify-center">
                                            <div className="text-4xl sm:text-6xl lg:text-8xl font-black gold-text-impact mb-1 break-words leading-tight py-2 text-center w-full">{redrawDisplay?.name}</div>
                                            <div className="text-lg md:text-2xl font-bold gold-text-impact mb-6 tracking-widest opacity-90 text-center w-full">{redrawDisplay?.group}</div>
                                            
                                            <div className="bg-red-50 rounded-[16px] md:rounded-[24px] p-3 md:p-6 mb-6 border-[3px] md:border-[5px] border-red-100 shadow-inner w-full text-center max-w-3xl">
                                                <div className="text-xs md:text-base text-red-500 font-black uppercase tracking-widest mb-1">Prize Won</div>
                                                <div className="text-2xl sm:text-4xl md:text-6xl font-black text-gray-800 leading-tight">
                                                    {lastWinner?.prize?.name}
                                                </div>
                                            </div>

                                            <div className="flex flex-col md:flex-row gap-2 md:gap-4 pb-1 w-full max-w-2xl mt-auto">
                                                <button onClick={confirmWin} className="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 md:py-5 rounded-xl md:rounded-3xl font-black text-lg md:text-2xl hover:scale-105 transition shadow-xl flex items-center justify-center gap-2"><CheckCircle className="w-5 h-5 md:w-8 md:h-8"/> Á¢∫Ë™çÊî∂‰∏ã</button>
                                                <button onClick={handleRetryRedraw} className="flex-1 bg-gray-200 text-gray-600 py-3 md:py-5 rounded-xl md:rounded-3xl font-black text-lg md:text-2xl hover:bg-gray-300 hover:scale-105 transition shadow-lg flex items-center justify-center gap-2"><RefreshCw className="w-5 h-5 md:w-8 md:h-8"/> Ê£ÑÊ¨äÈáçÊäΩ</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Main Winner Modal */}
                    {showWinnerModal && lastWinner && !showRedrawModal && (
                        <div className="fixed inset-0 bg-black/90 backdrop-blur-lg flex items-center justify-center z-50 p-4" onClick={() => {}}>
                            <div className="bg-white rounded-[40px] md:rounded-[60px] w-full max-w-5xl max-h-[90vh] flex flex-col relative shadow-[0_0_150px_rgba(250,204,21,0.8)] animate-pop rainbow-border overflow-visible transition-transform duration-300" style={{transform: 'scale(0.97)'}} onClick={e => e.stopPropagation()}>
                                <div className="absolute -top-10 md:-top-16 left-1/2 -translate-x-1/2 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full p-3 md:p-5 border-[4px] md:border-[6px] border-white shadow-2xl z-20">
                                    <Trophy size={36} className="text-white md:hidden" strokeWidth={2.5} />
                                    <Trophy size={72} className="text-white hidden md:block" strokeWidth={2.5} />
                                </div>
                                <div className="overflow-y-auto px-4 md:px-10 py-5 md:py-8 flex-1 custom-scrollbar mt-6 md:mt-8 rounded-[40px] flex flex-col items-center w-full">
                                    <h2 className="text-lg md:text-3xl font-black text-gray-300 mb-1 md:mb-3 uppercase tracking-[0.2em] text-center w-full mt-4 md:mt-0">Winner!</h2>
                                    <div className="text-4xl sm:text-6xl lg:text-8xl font-black gold-text-impact mb-1 break-words leading-tight py-1 text-center w-full">{lastWinner?.person?.name}</div>
                                    <div className="text-lg md:text-2xl font-bold gold-text-impact mb-3 md:mb-6 tracking-widest opacity-90 text-center w-full">{lastWinner?.person?.group || '‰∏ÄËà¨'}</div>
                                    <div className="bg-red-50 rounded-[16px] md:rounded-[24px] p-3 md:p-6 mb-3 md:mb-6 border-[3px] md:border-[5px] border-red-100 shadow-inner w-full text-center">
                                        <div className="text-xs md:text-base text-red-500 font-black uppercase tracking-widest mb-1">Prize Won</div>
                                        <div className="text-2xl sm:text-4xl md:text-6xl font-black text-gray-800 leading-tight">{lastWinner.prize.name}</div>
                                    </div>
                                    <div className="flex flex-col md:flex-row gap-2 md:gap-4 pb-1 w-full mt-auto">
                                        <button onClick={confirmWin} className="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 md:py-4 rounded-xl md:rounded-2xl font-black text-lg md:text-2xl hover:scale-105 transition shadow-xl uppercase tracking-wider flex items-center justify-center gap-2"><CheckCircle className="w-5 h-5 md:w-7 md:h-7"/> ÈñãÂøÉÊî∂‰∏ã üéâ</button>
                                        <button onClick={handleRedrawClick} className="flex-1 bg-gray-200 text-gray-600 py-3 md:py-4 rounded-xl md:rounded-2xl font-black text-lg md:text-2xl hover:bg-gray-300 hover:scale-105 transition shadow-lg uppercase tracking-wider flex items-center justify-center gap-2"><RefreshCw className="w-5 h-5 md:w-7 md:h-7"/> Ê£ÑÊ¨äÈáçÊäΩ üîÑ</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
